<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daily Stock Update</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 12px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 4px;
      text-align: center;
    }
    th {
      background: #f2f2f2;
    }
    .notes, .daily-sales {
      margin-top: 20px;
      text-align: left;
    }
    .notes ul {
      list-style-type: disc;
      padding-left: 20px;
      display: flex;
      gap: 40px;
    }
    .controls {
      margin-top: 20px;
      display: flex;
      gap: 10px;
    }

    /* ✅ Only for PDF export (shrinks content so it fits in A4) */
    .pdf-mode {
      font-size: 10px;
    }
    .pdf-mode table {
      font-size: 10px;
    }
  </style>
</head>
<body>
  <h2>Daily Stock Update</h2>

  <!-- Date input -->
  <label>Date: <input type="date" id="dateInput"></label>

  <div id="main-content">
    <table>
      <thead>
        <tr>
          <th>Item</th>
          <th>Opening Stock</th>
          <th>Closing Stock</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        <!-- Example row -->
        <tr>
          <td>Sloppy Joe</td>
          <td><input type="text" placeholder="Opening"></td>
          <td><input type="text" placeholder="Closing"></td>
          <td>
            <label><input type="checkbox"> Beli</label>
            <label><input type="checkbox"> Bawak</label>
          </td>
        </tr>
        <tr>
          <td>Smash Burger</td>
          <td><input type="text" placeholder="Opening"></td>
          <td><input type="text" placeholder="Closing"></td>
          <td>
            <label><input type="checkbox"> Beli</label>
            <label><input type="checkbox"> Bawak</label>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Notes -->
    <div class="notes">
      <strong>Notes:</strong>
      <ul>
        <li><input type="text" placeholder="Note 1"></li>
        <li><input type="text" placeholder="Note 2"></li>
        <li><input type="text" placeholder="Note 3"></li>
      </ul>
    </div>

    <!-- Daily Sales -->
    <div class="daily-sales">
      <strong>Daily Sales:</strong> <input type="text" placeholder="Enter total">
    </div>
  </div>

  <!-- Buttons -->
  <div class="controls">
    <button onclick="downloadPDF()">Download PDF</button>
    <button onclick="clearAll()">Clear All</button>
  </div>

  <!-- Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    async function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const mainContent = document.getElementById("main-content");

      // ✅ Get date from input field for filename
      let selectedDate = document.getElementById("dateInput")?.value;
      if (!selectedDate) {
        selectedDate = new Date().toISOString().split("T")[0];
      }
      const filename = `Stock-${selectedDate}.pdf`;

      // ✅ Add temporary PDF styling
      mainContent.classList.add("pdf-mode");

      // ✅ Replace checkboxes with symbols for PDF
      const checkboxes = [];
      mainContent.querySelectorAll("input[type=checkbox]").forEach(cb => {
        checkboxes.push({ element: cb, checked: cb.checked });
        const span = document.createElement("span");
        span.textContent = cb.checked ? "☑" : "☐";
        cb.style.display = "none";
        cb.parentNode.insertBefore(span, cb.nextSibling);
      });

      // Render content
      const canvas = await html2canvas(mainContent, { scale: 2, useCORS: true });

      // ✅ Restore checkboxes + remove temporary class
      checkboxes.forEach(cbObj => {
        cbObj.element.style.display = "";
        if (cbObj.element.nextSibling && cbObj.element.nextSibling.textContent?.match(/[☑☐]/)) {
          cbObj.element.nextSibling.remove();
        }
      });
      mainContent.classList.remove("pdf-mode");

      // Generate PDF
      const imgData = canvas.toDataURL("image/png");
      const pdf = new jsPDF("p", "mm", "a4");
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const ratio = Math.min(pageWidth / canvas.width, pageHeight / canvas.height);
      const imgWidth = canvas.width * ratio;
      const imgHeight = canvas.height * ratio;

      pdf.addImage(imgData, "PNG", 0, 0, imgWidth, imgHeight);
      pdf.save(filename);
    }

    // ✅ Password-protected Clear All
    function clearAll() {
      const password = prompt("Enter password to clear all:");
      if (password === "123") {
        document.querySelectorAll("input[type=text], input[type=date]").forEach(el => el.value = "");
        document.querySelectorAll("input[type=checkbox]").forEach(cb => cb.checked = false);
      } else {
        alert("Incorrect password!");
      }
    }
  </script>
</body>
</html>
