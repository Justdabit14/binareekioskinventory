<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daily Stock Update</title>
  <style>
body { font-family: Arial, sans-serif; margin: 10px; }
h1 { text-align: center; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
input[type="number"], input[type="text"] { width: 70px; text-align: center; margin: 2px; }
button { margin: 10px 5px; padding: 10px; background: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer; }
.category { background: #f0f0f0; font-weight: bold; text-align: left; }

td:first-child { text-align: left; padding-left: 8px; }

.notes { margin-top: 20px; text-align: left; }
.notes ul { list-style-type: disc; padding-left: 20px; }
.notes li { margin-bottom: 6px; }
.notes input { width: 80%; text-align: left; padding: 4px; }

.clear-btn{
  margin: 10px 5px;
  padding: 10px;
  background: #f44336;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

/* Added styles to place Notes and Sales/Capital/Staffs side-by-side */
.bottom-section {
  display: flex;
  gap: 24px;
  align-items: flex-start;
  margin-top: 12px;
}
.bottom-left { flex: 1; min-width: 220px; }

/* right area now split: left = sales/capital, right = staffs */
.bottom-right {
  display: flex;
  gap: 12px;
  align-items: flex-start;
  width: 420px;
}
.right-left { width: 240px; }
.right-right { width: 160px; }

.bottom-right .block {
  margin-bottom: 12px;
}
.bottom-right .block label { display: block; font-weight: 600; margin-bottom: 6px; }

/* Make the Daily Sales / Daily Capital inputs smaller again */
.bottom-right .block input[type="number"],
.bottom-right .block input[type="text"] {
  width: 120px; /* smaller fixed width */
  box-sizing: border-box;
  padding: 6px;
  text-align: center;
}

/* Staffs styling */
.staffs-title { display:block; font-weight:600; margin-bottom:6px; }
.staffs label { display:block; font-weight: normal; margin: 4px 0; }
  </style>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4CAF50">
</head>
<body>

  <h1>Daily Stock Update</h1>
  <label>Date: <input type="date" id="date"></label>

  <table id="stockTable">
    <thead>
      <tr>
        <th>Item</th>
        <th>Opening</th>
        <th>Closing</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="bottom-section">
    <div class="bottom-left">
      <h3>Notes</h3>
      <div class="notes">
        <input type="text" id="note1" placeholder="â€¢ Note 1">
        <input type="text" id="note2" placeholder="â€¢ Note 2">
        <input type="text" id="note3" placeholder="â€¢ Note 3">
      </div>
    </div>

    <div class="bottom-right">
      <div class="right-left">
        <div class="block">
          <label for="dailySales">Daily Sales</label>
          <input type="number" id="dailySales" placeholder="Enter daily sales (RM)">
        </div>

        <div class="block">
          <label for="dailyCapital">Daily Capital</label>
          <input type="number" id="dailyCapital" placeholder="Enter daily capital (RM)">
        </div>
      </div>

      <div class="right-right">
        <label class="staffs-title">Staffs</label>
        <div class="staffs">
          <label><input type="checkbox" id="staff1"> Ain</label>
          <label><input type="checkbox" id="staff2"> Achik</label>
          <label><input type="checkbox" id="staff3"> Adik</label>
          <label><input type="checkbox" id="staff4"> Awin</label>
        </div>
      </div>
    </div>
  </div>

  <button onclick="downloadPDF()">â¬‡ Download PDF</button>
  <button class="clear-btn" onclick="clearAll()">ðŸ—‘ Clear All</button>
  <button onclick="saveData()">ðŸ’¾ Save</button>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- html2canvas (needed to render the table exactly) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    async function downloadPDF() {
      try {
        const { jsPDF } = window.jspdf;
        if (!window.html2canvas) throw new Error("html2canvas not loaded");

        // page and conversion setup (A4 portrait)
        const pdf = new jsPDF('p', 'mm', 'a4');
        const margin = 8; // mm margins
        const pageW = pdf.internal.pageSize.getWidth();
        const pageH = pdf.internal.pageSize.getHeight();
        const pageInnerW = pageW - margin * 2;
        const pageInnerH = pageH - margin * 2;

        // px->mm helper and canvas scale for sharp output
        const pxToMm = 25.4 / 96;
        const renderScale = Math.max(2, Math.round((window.devicePixelRatio || 1) * 2));
        const wrapperCssWidthPx = Math.round(pageInnerW / (pxToMm * renderScale));

        // helpers
        const val = id => {
          const el = document.getElementById(id);
          if (!el) return '';
          if (el.type === 'checkbox' || el.type === 'radio') return el.checked;
          return el.value || '';
        };
        const safe = s => String(s).replace(/[^a-z0-9\-_]/gi, '_');

        // Build one single full-width printable table (category headers + rows)
        function buildSingleTable() {
          const table = document.createElement('table');
          table.style.width = '100%';
          table.style.borderCollapse = 'collapse';
          table.style.fontSize = '11px';
          table.style.border = '1px solid #bbb';
          table.innerHTML = `<thead>
            <tr>
              <th style="border:1px solid #ccc;padding:6px;text-align:left;width:40%">Item</th>
              <th style="border:1px solid #ccc;padding:6px;text-align:center;width:20%">Opening</th>
              <th style="border:1px solid #ccc;padding:6px;text-align:center;width:20%">Closing</th>
              <th style="border:1px solid #ccc;padding:6px;text-align:center;width:20%">Status</th>
            </tr>
          </thead>`;
          const tb = document.createElement('tbody');

          Object.keys(categories).forEach(cat => {
            const hdr = document.createElement('tr');
            hdr.innerHTML = `<td colspan="4" style="padding:6px;background:#f0f0f0;font-weight:700;text-align:left">${cat}</td>`;
            tb.appendChild(hdr);

            categories[cat].forEach(item => {
              const idBase = `${safe(cat)}-${safe(item)}`;
              let rowInner = '';
              if (item === 'Egg') {
                rowInner = `<td style="text-align:left;padding:6px">${item}</td>
                  <td style="padding:6px;text-align:center"><input value="${val('openCtn-'+idBase) || ''}" readonly style="width:40px;text-align:center"> ctn <input value="${val('openPcs-'+idBase) || ''}" readonly style="width:40px;text-align:center"> pcs</td>
                  <td style="padding:6px;text-align:center"><input value="${val('closeCtn-'+idBase) || ''}" readonly style="width:40px;text-align:center"> ctn <input value="${val('closePcs-'+idBase) || ''}" readonly style="width:40px;text-align:center"> pcs</td>
                  <td style="padding:6px;text-align:center"><label><input type="checkbox" ${val('beli-'+idBase) ? 'checked' : ''} disabled> Beli</label> <label><input type="checkbox" ${val('bawak-'+idBase) ? 'checked' : ''} disabled> Bawak</label></td>`;
              } else if (item === 'Smash Burger') {
                rowInner = `<td style="text-align:left;padding:6px">${item}</td>
                  <td style="padding:6px;text-align:center"><input value="${val('openPcs-'+idBase) || ''}" readonly style="width:60px;text-align:center"> pcs</td>
                  <td style="padding:6px;text-align:center"><input value="${val('closePcs-'+idBase) || ''}" readonly style="width:60px;text-align:center"> pcs</td>
                  <td style="padding:6px;text-align:center"><label><input type="checkbox" ${val('beli-'+idBase) ? 'checked' : ''} disabled> Beli</label> <label><input type="checkbox" ${val('bawak-'+idBase) ? 'checked' : ''} disabled> Bawak</label></td>`;
              } else if (item === 'Tomato Puree') {
                rowInner = `<td style="text-align:left;padding:6px">${item}</td>
                  <td style="padding:6px;text-align:center"><input value="${val('openCans-'+idBase) || ''}" readonly style="width:60px;text-align:center"> cans</td>
                  <td style="padding:6px;text-align:center"><input value="${val('closeCans-'+idBase) || ''}" readonly style="width:60px;text-align:center"> cans</td>
                  <td style="padding:6px;text-align:center"><label><input type="checkbox" ${val('beli-'+idBase) ? 'checked' : ''} disabled> Beli</label> <label><input type="checkbox" ${val('bawak-'+idBase) ? 'checked' : ''} disabled> Bawak</label></td>`;
              } else if (['Sauces & Spices','Cheese','Sayur'].includes(cat) || item === 'Oil' || item === 'Margarine' || item === 'Sloppy Joe' || item === 'Black Pepper' || item === 'White Pepper') {
                rowInner = `<td style="text-align:left;padding:6px">${item}</td>
                  <td style="padding:6px;text-align:center"><input value="${val('open-'+idBase) || ''}" readonly style="width:80px;text-align:center"></td>
                  <td style="padding:6px;text-align:center"><input value="${val('close-'+idBase) || ''}" readonly style="width:80px;text-align:center"></td>
                  <td style="padding:6px;text-align:center"><label><input type="checkbox" ${val('beli-'+idBase) ? 'checked' : ''} disabled> Beli</label> <label><input type="checkbox" ${val('bawak-'+idBase) ? 'checked' : ''} disabled> Bawak</label></td>`;
              } else {
                rowInner = `<td style="text-align:left;padding:6px">${item}</td>
                  <td style="padding:6px;text-align:center"><input value="${val('openPkt-'+idBase) || ''}" readonly style="width:50px;text-align:center"> pkt <input value="${val('openPcs-'+idBase) || ''}" readonly style="width:50px;text-align:center"> pcs</td>
                  <td style="padding:6px;text-align:center"><input value="${val('closePkt-'+idBase) || ''}" readonly style="width:50px;text-align:center"> pkt <input value="${val('closePcs-'+idBase) || ''}" readonly style="width:50px;text-align:center"> pcs</td>
                  <td style="padding:6px;text-align:center"><label><input type="checkbox" ${val('beli-'+idBase) ? 'checked' : ''} disabled> Beli</label> <label><input type="checkbox" ${val('bawak-'+idBase) ? 'checked' : ''} disabled> Bawak</label></td>`;
              }

              const tr = document.createElement('tr');
              tr.style.borderTop = '1px solid #e0e0e0';
              tr.innerHTML = rowInner;
              tb.appendChild(tr);
            });
          });

          table.appendChild(tb);
          return table;
        }

        // Build printable wrapper (full page width inside margins)
        const wrap = document.createElement('div');
        wrap.style.position = 'fixed';
        wrap.style.left = '-9999px';
        wrap.style.top = '0';
        wrap.style.background = '#fff';
        wrap.style.width = wrapperCssWidthPx + 'px';
        wrap.style.boxSizing = 'border-box';
        wrap.style.padding = '0';
        wrap.style.fontFamily = 'Arial, sans-serif';
        wrap.style.color = '#000';
        // header + compact date
        const header = document.querySelector('h1')?.cloneNode(true);
        if (header) {
          header.style.margin = '0 0 6px 0';
          header.style.fontSize = '16px';
          header.style.textAlign = 'center';
          wrap.appendChild(header);
        }
        const dateLabel = document.querySelector('label')?.cloneNode(true);
        if (dateLabel) {
          const orig = document.getElementById('date');
          const input = dateLabel.querySelector('input');
          if (orig && input) { input.value = orig.value || ''; input.readOnly = true; input.style.pointerEvents = 'none'; }
          dateLabel.style.display = 'block';
          dateLabel.style.margin = '0 0 8px 0';
          wrap.appendChild(dateLabel);
        }

        // append simple single table
        wrap.appendChild(buildSingleTable());

        // append bottom (notes/sales/staffs) â€” copy values
        const bottom = document.querySelector('.bottom-section')?.cloneNode(true);
        if (bottom) {
          bottom.querySelectorAll('input').forEach(inp => {
            const id = inp.id;
            if (!id) return;
            const live = document.getElementById(id);
            if (!live) return;
            if (live.type === 'checkbox') inp.checked = live.checked;
            else inp.value = live.value || '';
            inp.readOnly = true;
            inp.style.pointerEvents = 'none';
          });
          bottom.style.marginTop = '10px';
          wrap.appendChild(bottom);
        }

        document.body.appendChild(wrap);

        // render wrapper
        const canvas = await html2canvas(wrap, { scale: renderScale, backgroundColor: '#fff', useCORS: true });
        document.body.removeChild(wrap);

        // convert and fit to full printable width â€” paginate vertically if needed
        const canvasWidthMm = canvas.width * pxToMm;
        const canvasHeightMm = canvas.height * pxToMm;
        const widthScale = pageInnerW / canvasWidthMm;
        const imgWmm = pageInnerW;
        const imgHmm = canvasHeightMm * widthScale;
        const imgData = canvas.toDataURL('image/png');

        // add first page
        pdf.addImage(imgData, 'PNG', margin, margin, imgWmm, imgHmm);

        // paginate by shifting the large image up on new pages
        if (imgHmm > pageInnerH) {
          let remaining = imgHmm - pageInnerH;
          let offset = pageInnerH;
          while (remaining > 0) {
            pdf.addPage();
            // place the same image shifted up so next slice is visible
            pdf.addImage(imgData, 'PNG', margin, margin - offset, imgWmm, imgHmm);
            remaining -= pageInnerH;
            offset += pageInnerH;
          }
        }

        const date = document.getElementById('date')?.value || '(No Date)';
        pdf.save('daily_stock_' + date + '.pdf');
      } catch (err) {
        alert('PDF export failed: ' + (err && err.message ? err.message : err));
        console.error(err);
      }
    }
  </script>

  <script>
    // Categories + items
    const categories = {
      "Patty": ["Daging","Ayam", "Ikan", "Kambing", "Sloppy Joe", "Smash Burger", "Crispy Chicken"],
      "Oblong": ["Daging","Ayam", "Kambing"],
      "Bread / Burger / Wrap": ["Bun", "Wrap","Oblong"],
      "Sauces & Spices": [
        "Chili Sauce", "Mayonnaise", "Special Sauce", "Cheese sauce",
        "Paprika Powder", "Curry Powder", "Garlic Powder", "Onion Powder", "Cayenne", "Worcestershire",
        "Black Pepper", "White Pepper", "Tomato Puree"
      ],
      "Cheese": ["Cheese Slice", "Cream Cheese"],
      "Sayur": ["Onion", "Cucumber", "Salad"],
      "Others": ["Paper Wrapping", "Fries", "Egg", "Oil", "Margarine"]  // added "Margarine"
    };

    const tbody = document.querySelector("#stockTable tbody");

    // Generate rows
    Object.keys(categories).forEach(cat => {
      tbody.innerHTML += `<tr class="category"><td colspan="4">${cat}</td></tr>`;

      // helper to create safe id parts (remove spaces/special chars)
      const safe = str => String(str).replace(/[^a-z0-9\-_]/gi, '_');

      categories[cat].forEach(item => {
        const base = safe(cat) + '-' + safe(item);
        let rowHTML = "";

        // Special cases
        if (item === "Sloppy Joe" || item === "Black Pepper" || item === "White Pepper") {
          rowHTML = `
            <tr>
              <td>${item}</td>
              <td><input type="text" id="open-${base}" placeholder="Opening"></td>
              <td><input type="text" id="close-${base}" placeholder="Closing"></td>
              <td>
                <label><input type="checkbox" id="beli-${base}"> Beli</label>
                <label><input type="checkbox" id="bawak-${base}"> Bawak</label>
              </td>
            </tr>`;
        } 
        else if (item === "Smash Burger") {
          rowHTML = `
            <tr>
              <td>${item}</td>
              <td><input type="number" id="openPcs-${base}" placeholder="Pcs"> pcs</td>
              <td><input type="number" id="closePcs-${base}" placeholder="Pcs"> pcs</td>
              <td>
                <label><input type="checkbox" id="beli-${base}"> Beli</label>
                <label><input type="checkbox" id="bawak-${base}"> Bawak</label>
              </td>
            </tr>`;
        }
        else if (item === "Egg") {
          rowHTML = `
            <tr>
              <td>${item}</td>
              <td>
                <input type="number" id="openCtn-${base}" placeholder="Ctn"> ctn
                <input type="number" id="openPcs-${base}" placeholder="Pcs"> pcs
              </td>
              <td>
                <input type="number" id="closeCtn-${base}" placeholder="Ctn"> ctn
                <input type="number" id="closePcs-${base}" placeholder="Pcs"> pcs
              </td>
              <td>
                <label><input type="checkbox" id="beli-${base}"> Beli</label>
                <label><input type="checkbox" id="bawak-${base}"> Bawak</label>
              </td>
            </tr>`;
        }
        else if (item === "Tomato Puree") {
          rowHTML = `
            <tr>
              <td>${item}</td>
              <td><input type="number" id="openCans-${base}" placeholder="Cans"> cans</td>
              <td><input type="number" id="closeCans-${base}" placeholder="Cans"> cans</td>
              <td>
                <label><input type="checkbox" id="beli-${base}"> Beli</label>
                <label><input type="checkbox" id="bawak-${base}"> Bawak</label>
              </td>
            </tr>`;
        }
        else if (["Sauces & Spices", "Cheese", "Sayur"].includes(cat) || item === "Oil" || item === "Margarine") {
          rowHTML = `
            <tr>
              <td>${item}</td>
              <td><input type="text" id="open-${base}" placeholder="Opening"></td>
              <td><input type="text" id="close-${base}" placeholder="Closing"></td>
              <td>
                <label><input type="checkbox" id="beli-${base}"> Beli</label>
                <label><input type="checkbox" id="bawak-${base}"> Bawak</label>
              </td>
            </tr>`;
        } 
        else {
          // Default: pkt + pcs
          rowHTML = `
            <tr>
              <td>${item}</td>
              <td>
                <input type="number" id="openPkt-${base}" placeholder="Pkt"> pkt
                <input type="number" id="openPcs-${base}" placeholder="Pcs"> pcs
              </td>
              <td>
                <input type="number" id="closePkt-${base}" placeholder="Pkt"> pkt
                <input type="number" id="closePcs-${base}" placeholder="Pcs"> pcs
              </td>
              <td>
                <label><input type="checkbox" id="beli-${base}"> Beli</label>
                <label><input type="checkbox" id="bawak-${base}"> Bawak</label>
              </td>
            </tr>`;
        }
        tbody.innerHTML += rowHTML;
      });
    });

    // Clear all
    function clearAll() {
      const password = prompt("Enter password to clear all:");
      if (password === "123") {
        document.querySelectorAll("input[type='number'], input[type='text']").forEach(input => input.value = "");
        document.querySelectorAll("input[type='checkbox']").forEach(chk => chk.checked = false);
        localStorage.removeItem("stockData");
        alert("All fields cleared!");
      } else if (password !== null) {
        alert("Incorrect password!");
      }
    }

    // Save/load localStorage
    function saveData() {
      let data = {};
      document.querySelectorAll("input").forEach(input => {
        if (input.type === "checkbox") data[input.id] = input.checked;
        else data[input.id] = input.value;
      });
      localStorage.setItem("stockData", JSON.stringify(data));
      alert("Data saved!");
    }

    window.onload = () => {
      let saved = localStorage.getItem("stockData");
      if (saved) {
        saved = JSON.parse(saved);
        Object.keys(saved).forEach(id => {
          let input = document.getElementById(id);
          if (input) {
            if (input.type === "checkbox") input.checked = saved[id];
            else input.value = saved[id];
          }
        });
      }
    };
  </script>

<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js")
      .then(() => console.log("Service Worker registered"));
  }
</script>

</body>
</html>
