<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Daily Stock Update</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50">
  <style>
    body { font-family: Arial, sans-serif; margin: 10px; }
    h1 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    input[type="number"], input[type="text"] { width: 70px; text-align: center; margin: 2px; }
    button { margin: 10px 5px; padding: 10px; background: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer; }
    .category { background: #f0f0f0; font-weight: bold; text-align: left; }
    td:first-child { text-align: left; padding-left: 8px; }
    .notes { margin-top: 20px; text-align: left; }
    .notes ul { list-style-type: disc; padding-left: 20px; }
    .notes li { margin-bottom: 6px; }
    .notes input { width: 80%; text-align: left; padding: 4px; }
    .clear-btn{
      margin: 10px 5px;
      padding: 10px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <h1>Daily Stock Update</h1>
  <label>Date: <input type="date" id="date"></label>

  <!-- Wrap all main content -->
  <div id="mainContent">
    <table id="stockTable">
      <thead>
        <tr>
          <th>Item</th>
          <th>Opening</th>
          <th>Closing</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="bottom-section">
      <h3>Notes</h3>
      <div class="notes">
        <input type="text" id="note1" placeholder="â€¢ Note 1">
        <input type="text" id="note2" placeholder="â€¢ Note 2">
        <input type="text" id="note3" placeholder="â€¢ Note 3">
      </div>

      <h3>Daily Sales</h3>
      <div class="sales">
        <input type="number" id="dailySales" placeholder="Enter daily sales (RM)">
      </div>
    </div>
  </div>
  <!-- End mainContent -->

  <button onclick="downloadPDF()">â¬‡ Download PDF</button>
  <button class="clear-btn" onclick="clearAll()">ðŸ—‘ Clear All</button>
  <button onclick="saveData()">ðŸ’¾ Save</button>

  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // Categories + items
    const categories = {
      "Patty": ["Daging","Ayam", "Kambing", "Sloppy Joe", "Smash Burger", "Crispy Chicken","Ikan"],
      "Oblong": ["Daging","Ayam", "Kambing"],
      "Bread / Burger / Wrap": ["Bun", "Wrap","Oblong"],
      "Sauces & Spices": [
        "Chili Sauce", "Mayonnaise", "Special Sauce", "Cheese sauce",
        "Paprika Powder", "Curry Powder", "Garlic Powder","Onion Powder", "Cayenne", "Worcestershire",
        "Black Pepper", "White Pepper", "Tomato Puree"
      ],
      "Cheese": ["Cheese Slice", "Cream Cheese"],
      "Sayur": ["Onion", "Cucumber", "Salad"],
      "Others": ["Paper Wrapping", "Fries", "Egg","Margarine"]
    };

    const tbody = document.querySelector("#stockTable tbody");

    // Generate rows
    Object.keys(categories).forEach(cat => {
      tbody.innerHTML += `<tr class="category"><td colspan="4">${cat}</td></tr>`;
      categories[cat].forEach(item => {
        let rowHTML = "";

        // Special cases
        if (item === "Sloppy Joe" || item === "Black Pepper" || item === "White Pepper") {
          rowHTML = `
            <tr>
              <td>${item}</td>
              <td><input type="text" id="open-${item}" placeholder="Opening"></td>
              <td><input type="text" id="close-${item}" placeholder="Closing"></td>
              <td>
                <label><input type="checkbox" id="beli-${item}"> Beli</label>
                <label><input type="checkbox" id="bawak-${item}"> Bawak</label>
              </td>
            </tr>`;
        } 
        else if (item === "Smash Burger") {
          rowHTML = `
            <tr>
              <td>${item}</td>
              <td><input type="number" id="openPcs-${item}" placeholder="Pcs"> pcs</td>
              <td><input type="number" id="closePcs-${item}" placeholder="Pcs"> pcs</td>
              <td>
                <label><input type="checkbox" id="beli-${item}"> Beli</label>
                <label><input type="checkbox" id="bawak-${item}"> Bawak</label>
              </td>
            </tr>`;
        }
        else if (item === "Egg") {
          rowHTML = `
            <tr>
              <td>${item}</td>
              <td>
                <input type="number" id="openCtn-${item}" placeholder="Ctn"> ctn
                <input type="number" id="openPcs-${item}" placeholder="Pcs"> pcs
              </td>
              <td>
                <input type="number" id="closeCtn-${item}" placeholder="Ctn"> ctn
                <input type="number" id="closePcs-${item}" placeholder="Pcs"> pcs
              </td>
              <td>
                <label><input type="checkbox" id="beli-${item}"> Beli</label>
                <label><input type="checkbox" id="bawak-${item}"> Bawak</label>
              </td>
            </tr>`;
        }
        else if (item === "Tomato Puree") {
          rowHTML = `
            <tr>
              <td>${item}</td>
              <td><input type="number" id="openCans-${item}" placeholder="Cans"> cans</td>
              <td><input type="number" id="closeCans-${item}" placeholder="Cans"> cans</td>
              <td>
                <label><input type="checkbox" id="beli-${item}"> Beli</label>
                <label><input type="checkbox" id="bawak-${item}"> Bawak</label>
              </td>
            </tr>`;
        }
        else if (["Sauces & Spices", "Cheese", "Sayur"].includes(cat)) {
          // Free text for sauces, spices, cheese, sayur
          rowHTML = `
            <tr>
              <td>${item}</td>
              <td><input type="text" id="open-${item}" placeholder="Opening"></td>
              <td><input type="text" id="close-${item}" placeholder="Closing"></td>
              <td>
                <label><input type="checkbox" id="beli-${item}"> Beli</label>
                <label><input type="checkbox" id="bawak-${item}"> Bawak</label>
              </td>
            </tr>`;
        } 
        else {
          // Default: pkt + pcs
          rowHTML = `
            <tr>
              <td>${item}</td>
              <td>
                <input type="number" id="openPkt-${item}" placeholder="Pkt"> pkt
                <input type="number" id="openPcs-${item}" placeholder="Pcs"> pcs
              </td>
              <td>
                <input type="number" id="closePkt-${item}" placeholder="Pkt"> pkt
                <input type="number" id="closePcs-${item}" placeholder="Pcs"> pcs
              </td>
              <td>
                <label><input type="checkbox" id="beli-${item}"> Beli</label>
                <label><input type="checkbox" id="bawak-${item}"> Bawak</label>
              </td>
            </tr>`;
        }
        tbody.innerHTML += rowHTML;
      });
    });

    // PDF Export (adds date text + preserves checkmarks)
  async function downloadPDF() {
  const { jsPDF } = window.jspdf;
  const mainContent = document.getElementById("mainContent");

  // Date for header + filename
  let selectedDate = document.getElementById("date")?.value;
  if (!selectedDate) selectedDate = new Date().toISOString().split("T")[0];
  const filename = `Stock-${selectedDate}.pdf`;

  // Swap real checkboxes with symbols so html2canvas captures them
  const swaps = [];
  mainContent.querySelectorAll("input[type=checkbox]").forEach(cb => {
    swaps.push({ element: cb });
    const span = document.createElement("span");
    span.textContent = cb.checked ? "â˜‘" : "â˜";
    span.style.marginLeft = "4px";
    cb.style.display = "none";
    cb.parentNode.insertBefore(span, cb.nextSibling);
  });

  // âœ… Temporarily widen + shrink font for clean PDF layout
  const originalWidth = mainContent.style.width;
  const originalMaxWidth = mainContent.style.maxWidth;
  const originalFontSize = mainContent.style.fontSize;
  const originalLineHeight = mainContent.style.lineHeight;

  mainContent.style.width = "1000px";
  mainContent.style.maxWidth = "1000px";
  mainContent.style.fontSize = "12px";     // shrink slightly
  mainContent.style.lineHeight = "1.2";    // tighter spacing

  const canvas = await html2canvas(mainContent, { scale: 2, useCORS: true });

  // Restore styles
  mainContent.style.width = originalWidth;
  mainContent.style.maxWidth = originalMaxWidth;
  mainContent.style.fontSize = originalFontSize;
  mainContent.style.lineHeight = originalLineHeight;

  // Restore real checkboxes
  swaps.forEach(s => {
    s.element.style.display = "";
    const next = s.element.nextSibling;
    if (next && next.nodeType === 1 && /[â˜‘â˜]/.test(next.textContent || "")) next.remove();
  });

  const imgData = canvas.toDataURL("image/png");
  const pdf = new jsPDF("p", "mm", "a4");
  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();

  // ðŸ“ Define margins
  const marginLeft = 15;   // left padding
  const marginRight = 15;  // right padding
  const marginTop = 12;    // below header
  const marginBottom = 12; // bottom padding
  const usableWidth = pageWidth - marginLeft - marginRight;
  const usableHeight = pageHeight - marginTop - marginBottom;

  // Fit content into usable area
  const imgWidth = usableWidth;
  const imgHeight = (canvas.height * usableWidth) / canvas.width;

  const scaleFactor = usableHeight / imgHeight;
  const finalHeight = imgHeight * scaleFactor;

  // Add date header
  pdf.setFontSize(12);
  pdf.text(`Date: ${selectedDate}`, marginLeft, 8);

  // Draw resized image centered within margins
  pdf.addImage(imgData, "PNG", marginLeft, marginTop, usableWidth, finalHeight);

  pdf.save(filename);
}



    // Clear all
    function clearAll() {
      const password = prompt("Enter password to clear all (Asree's Only):");
      if (password === "123") {
        document.querySelectorAll("input[type='number'], input[type='text']").forEach(input => input.value = "");
        document.querySelectorAll("input[type='checkbox']").forEach(chk => chk.checked = false);
        localStorage.removeItem("stockData");
        alert("All fields cleared!");
      } else if (password !== null) {
        alert("Incorrect password!");
      }
    }

    // Save/load localStorage
    function saveData() {
      let data = {};
      document.querySelectorAll("input").forEach(input => {
        if (input.type === "checkbox") data[input.id] = input.checked;
        else data[input.id] = input.value;
      });
      localStorage.setItem("stockData", JSON.stringify(data));
      alert("Data saved!");
    }

    window.onload = () => {
      let saved = localStorage.getItem("stockData");
      if (saved) {
        saved = JSON.parse(saved);
        Object.keys(saved).forEach(id => {
          let input = document.getElementById(id);
          if (input) {
            if (input.type === "checkbox") input.checked = saved[id];
            else input.value = saved[id];
          }
        });
      }
    };
  </script>

  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js")
        .then(() => console.log("Service Worker registered"));
    }
  </script>

</body>
</html>






